# ==========================
# æ„å»ºé˜¶æ®µ
# ==========================
FROM node:20 AS build-stage
WORKDIR /usr/src/app

# å®šä¹‰å¯ä¼ å…¥çš„å‚æ•°
ARG VITE_API_URL
ENV VITE_API_URL=$VITE_API_URL

COPY . .
RUN npm ci

RUN npm run build

# ==========================
# æµ‹è¯•é˜¶æ®µ
# ==========================
FROM node:20 AS test-stage
WORKDIR /usr/src/app

# æ‹·è´ build-stage çš„æ–‡ä»¶å’Œ node_modules
COPY --from=build-stage /usr/src/app /usr/src/app

# è®¾ç½® CI ç¯å¢ƒï¼Œä¿è¯ Vitest ç­‰æµ‹è¯•å·¥å…·åœ¨éäº¤äº’ç¯å¢ƒä¸‹æ­£ç¡®é€€å‡º
ENV CI=true

# âœ… è¿è¡Œæµ‹è¯•ï¼šå¦‚æœ Vitest è¿”å›é 0ï¼ŒDocker build ä¼šå¤±è´¥
RUN npm run test

# ==========================
# ç”Ÿäº§é˜¶æ®µ
# ==========================
FROM nginx:1.25-alpine AS production
WORKDIR /usr/share/nginx/html

# ğŸ‘‡ production é˜¶æ®µä¾èµ– test-stage
COPY --from=test-stage /usr/src/app/dist .

# è‡ªå®šä¹‰ Nginx é…ç½®
COPY nginx.conf /etc/nginx/conf.d/default.conf
